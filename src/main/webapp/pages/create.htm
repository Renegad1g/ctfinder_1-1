<div class="container">
	<div class="row">
		<div class="col s12 m3 l3 xl3">
			<h5>Создать</h5>
			<div class="card">
				<div class="card-content">
					<form id="create-offer-form">
						<div class="input-field">
		                    <input type="text" name="title" id="title">
		                    <label for="title">title:</label>
	                    </div>
	                    <div class="input-field">
		                    <label for="content">content:</label>
		                    <textarea name="content" id="content" class="materialize-textarea"></textarea>
	                    </div>
	                    <!-- Сюда при помощи jquery помещается шаблон, заполненный offer types -->
                        <div id="offer-type-select" class="input-field">
                        	<select id="offertypeselector" name="offertypeselector" required="required" class="validate">
			                	<option disabled selected="selected" value="">Тип задания</option>
			                </select>
						</div>
						<br>
						<div class="input-field">
							<input type="text" id="country-input" class="autocomplete" autocomplete="off">
							<label for="country-input">Страна</label>
						</div>
						<div class="input-field">
							<input type="text" id="city-input" class="autocomplete" autocomplete="off">
							<label for="city-input">Город</label>
						</div>
						<div class="input-field">
							<input type="number" id="c-count-input" min="1" placeholder="&infin;" value="">
							<label for="c-count-input">Вакантных мест</label>
						</div>
						<div class="row">
							<div class="input-field col s9">
	                      		<input type="text" id="start-date-input" class="datepicker">
	                      		<label for="start-date-input">Желаемая дата старта</label>
                      		</div>
                      		<div class="input-field col s3">
                      			<input type="button" class="waves-effect waves-light btn" id="remove-start-date" value="X">
							</div>
						</div>
						<div class="row">
							<div class="input-field col s9">
	                      		<input type="text" id="finish-date-input" class="datepicker">
	                      		<label for="finish-date-input">Желаемая дата окончания</label>
	                   		</div>
	                   		<div class="input-field col s3">
						        <input type="button" class="waves-effect waves-light btn" id="remove-finish-date" value="X">
		                    </div>
						</div>
						<div class="file-field input-field">
							<label for="image-input">Изображение</label>
							<div class="btn">
							  <span><i class="material-icons right">image</i></span>
							  <input type="file" id="image-input">
							</div>
							<div class="file-path-wrapper">
							  <input class="file-path validate" type="text">
							</div>
					    </div>
	                    <button class="btn waves-effect waves-light" type="submit" name="action">Submit
	                        <i class="material-icons right">send</i>
	                    </button>
					</form>
				</div>
			</div>
		</div>

		<div class="col s12 m9 l9 xl9">
			<h5>Предложения</h5>
			<div class="row">
				<div class="col s6">
					<form>
						<label for="calendarFrom"> Начиная с: </label> <input
							id="calendarFrom" name="calendarFrom" type="date"> </input>
					</form>
				</div>
				<div class="col s6">
					<form>
						<label for="calendarTo"> по: </label> <input
							id="calendarTo" name="calendarTo" type="date"> </input>
					</form>
				</div>
			</div>

			<!-- Сюда при помощи jquery помещается шаблон таблицы, заполненный данными offers -->
			<div class="row">
				<div class="col s12 m12 l12 xl12">
					<div id="table-container"></div>
				</div>
			</div>
			<div class="row">
				<div class="col s12 m12 l12 xl12">
					<div class="card horizontal">
						<div class="card-stacked">
							<div class="card-content">
								<form>
									<button id="doneOrder" class="waves-effect waves-light btn"
										type="button">Выполнен</button>
									<button id="cancelOrder" class="waves-effect waves-light btn"
										type="button">Отмена</button>
									<button id="deleteOrder" class="waves-effect waves-light btn"
										type="button">Удаление</button>
								</form>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">

	//Добавляем к стандартному типу Дата функцию коррекции даты по часовому поясу
	Date.prototype.toDateInputValue = (function() {
	    var local = new Date(this);
	    local.setMinutes(this.getMinutes() - this.getTimezoneOffset());
	    return local.toJSON().slice(0,10);
	});
	
	//Устанавливаем в элемент ввода Дата (Календарь) текущую дату,
    //вызывая на ней предварительно нашу корректирующую функцию
	$('form#create-offer-form input#start-date-input, form#create-offer-form input#finish-date-input')
		.val(new Date().toDateInputValue());
	
	//Задаем календарю окно допустимых дат - от текущей включительно -> infinity
    var minDate = new Date();
    $('form#create-offer-form input#start-date-input, form#create-offer-form input#finish-date-input')
	    .attr({
	       "min" : minDate.toDateInputValue(),
		});
    
    //console.log($('form#create-offer-form input#start-date-input, form#create-offer-form input#finish-date-input'));
  	//активация выбора даты
    $('form#create-offer-form input#start-date-input, form#create-offer-form input#finish-date-input').datepicker({
	    	'format':'dd-mm-yyyy'
	    	//, 'defaultDate':formatDate(new Date().toDateInputValue())
	    	, 'setDefaultDate':true
	    	, 'autoClose':true
		});
  	
    $('form#create-offer-form input#remove-start-date').click(function(ev){
		
		ev.preventDefault();
		$('form#create-offer-form input#start-date-input').val("");
    });
    
	$('form#create-offer-form input#remove-finish-date').click(function(ev){
		
		ev.preventDefault();
		$('form#create-offer-form input#finish-date-input').val("");
    });
    
  	//Блокируем кнопк, пока не будет
    $('form#create-offer-form button').prop('disabled', 'disabled');

	app.handler(function() {

		//console.log('this ' + $(this));
		//var $container = $(this).find("#page-container");
		//console.log('container ' + $container);

		return function(params) {
			
			var countryAutocompleteItems = {};
			var cityAutocompleteItems = {};
			
			//Блокируем кнопк, пока не будет
			$("form#create-offer-form button").attr('disabled', '');
			
			$.validator.setDefaults(
					{
						ignore: [],
						errorClass: 'invalid',
					    validClass: "valid",
					    errorPlacement: function (error, element) {
					        $(element)
					            .closest("form")
					            .find("label[for='" + element.attr("id") + "']")
					            .attr('data-error', error.text());
					    },
					    submitHandler: function (form) {
					        console.log('form ok');
					    }
					}
				);
			
			/*if($('form#create-offer-form #offer-type-select select option:selected').val() == ""){
				
				$('form#create-offer-form #offer-type-select select')[0].setCustomValidity('Тип задания не выбран');
				$('form#create-offer-form button').prop('disabled', 'disabled');
				console.log('setCustomValidity -');
			} else {
				
				$('form#create-offer-form #offer-type-select select')[0].setCustomValidity('');
				$('form#create-offer-form button').prop('disabled', false);
				console.log('setCustomValidity +');
			}*/
			
			/*$('form#create-offer-form #offer-type-select select').change(function(){
				
				//$('form#create-offer-form #offer-type-select select').valid();
				$('form#create-offer-form #offer-type-select select')[0].setCustomValidity('');
				$('form#create-offer-form button').prop('disabled', false);
				console.log('changed');
			});*/
			
			$('form#create-offer-form').validate({
		        rules: {
		        	title: {
		                required: true
		            },
		            content: {
		            	required: true
		            }
		        },
		        messages: {
		        	title: "Заголовок не заполнен",
		        	content: "Описание не заполнено"
		        }
		    });
			
			var isFormValid = function(){
				
				if ($('form#create-offer-form').valid()) {
		        	
		            $('form#create-offer-form button').prop('disabled', false);
		        } else {
		        	
		            $('form#create-offer-form button').prop('disabled', 'disabled');
		        }
				
				if($('form#create-offer-form #offer-type-select select option:selected').val() == ""){
					
					$('form#create-offer-form #offer-type-select select')[0].setCustomValidity('Тип задания не выбран');
					$('form#create-offer-form button').prop('disabled', 'disabled');
					//console.log('setCustomValidity -');
				} else {
					
					$('form#create-offer-form #offer-type-select select')[0].setCustomValidity('');
					$('form#create-offer-form button').prop('disabled', false);
					//console.log('setCustomValidity +');
				}
			}
			
			isFormValid();
		
		    $('form#create-offer-form input').on('keyup blur', function () {
		    	
		    	isFormValid();
		    });
		    
		    $(document).on(
		    		'change'
		    		, 'form#create-offer-form #offer-type-select select'
		    		, function() {
		        
		    	isFormValid();
		    });
		    
		    //Функция получения списка всех типов предложений
		    var populateOfferTypesSelect = function(){
		    	
		    	$.ajax({
					type: 'POST',
					url: '/offertype?action=get-all',
					dataType: 'json',
					cache: false
				}).done(function(responseText, textStatus, jqXHR) {
					  
					//console.log(responseText);
					//Готовим шаблон списка при помощи библиотеки Hogan
		            var template = Hogan.compile(
	            		'<select>'
	                    +'<option disabled="" selected="" value="">type choice</option>'
	                    +'{{#result}}'                
	                    +   '<option value="{{id}}">'
	                    +       '{{description}}'
	                    +   '</option>'
	                    +'{{/result}}'
		    			+'</select>'
		            );
		            //Заполняем шаблон данными и помещаем на веб-страницу
					$('#offer-type-select').html(template.render(responseText));
					$('#offer-type-select select').formSelect();
					
				}).fail(function(jqXHR, textStatus, errorThrown) {
					  
					//console.log(textStatus);
					alert("Ошибка получения списка типов заданий: " + jqXHR);
				});
		    }

		    populateOfferTypesSelect();
			
			var onCountryAutocompleteCallback = function(){

				console.log("country autocompleted");
			}
			
			var onCityAutocompleteCallback = function(){

				console.log("city autocompleted");
			}
			
			//country autocomplete
		    $('form#create-offer-form input#country-input').autocomplete({
		        data: countryAutocompleteItems
		        , onAutocomplete: onCountryAutocompleteCallback
			});
			
			//get created Autocomplete Instance from country-input
		    var countryAutocomplete =
		    	M.Autocomplete.getInstance($('form#create-offer-form input#country-input'));
			
			//handler for country-input keydown event
		    $('form#create-offer-form input#country-input').keydown(function(e) { 
				
				// only user-triggered event
				 if (e.originalEvent) {
					 
					 //clear city-input
					 $('form#create-offer-form input#city-input').val("");
					 //request data for country's Autocomplete
					 $.ajax({
					        url: "/country",
					        type: "POST",
					        data: {
					            'action': 'autocomplete'
					            , 'substring': $('form#create-offer-form input#country-input').val()
					        },
					        cache : false
					    }).done(function(newAutocompleteItems) {
					    	
					    	var newAutocompleteItemsObj =
					    		newAutocompleteItems.result.reduce(function(acc, cur, i) {
					  		  		acc[cur] = null;
					  		  		return acc;
					  			}, {});
					    	countryAutocomplete.updateData(newAutocompleteItemsObj);
					    	//
					    	//console.log(countryAutocomplete);
					    	countryAutocomplete.open();
					});
				 }
				 else {
				   // code-triggered event
				 }
			});
			
		  	//city autocomplete
		    $('form#create-offer-form input#city-input').autocomplete({
		        data: cityAutocompleteItems
		        , onAutocomplete: onCityAutocompleteCallback
			});
			
		    var cityAutocomplete =
		    	M.Autocomplete.getInstance($('form#create-offer-form input#city-input'));
			
		    $('form#create-offer-form input#city-input').unbind("keydown");
			$('form#create-offer-form input#city-input').keydown(function(e) { 
					
				// only user-triggered event
				 if (e.originalEvent) {
				 	
					 $.ajax({
					        url: "/city",
					        type: "POST",
					        data: {
					            'action': 'autocomplete'
				            	, 'country': $('form#create-offer-form input#country-input').val()
					            , 'substring': $('form#create-offer-form input#city-input').val()
					        },
					        cache : false
					    }).done(function(newAutocompleteItems) {
					    	
					    	var newAutocompleteItemsObj =
					    		newAutocompleteItems.result.reduce(function(acc, cur, i) {
					  		  		acc[cur] = null;
					  		  		return acc;
					  			}, {});
					    	cityAutocomplete.updateData(newAutocompleteItemsObj);
					    	//console.log(cityAutocomplete);
							
					    	cityAutocomplete.open();
					});
				 }
				 else {
				   // code-triggered event
				 }
			});
			
			var imageBase64 = "";
			$('form#create-offer-form input#image-input').unbind("change");
			$('form#create-offer-form input#image-input').change(function(ev){
				
				  //console.log($('form#create-offer-form input#image-input'));
				  var file = ev.target.files[0];
				  var reader = new FileReader();
				  reader.onloadend = function() {
		                        
		                        /*$.ajax({
		                            url: "/TestImgWebApp/image",
		                            type:'POST',
		                            data: {
		                                'image':reader.result
		                            }
		                          }).done(function(resp) {
		                              console.log(resp);
		                              $('img').attr('src',resp);
		                          });*/
		                        //console.log('RESULT', reader.result);
		                        imageBase64 = reader.result;
				  }
				  reader.readAsDataURL(file);
			});
			
			$('form#create-offer-form button').unbind("click");
			$('form#create-offer-form button').click(function(ev){
				
				ev.preventDefault();
				//console.log($('form#create-offer-form c-count-input').val());
				
				preloaderOn();
				
				var data = $('form#create-offer-form').serializeArray();
				
				data.push({name: 'action', value: 'create'});
				data.push({name: 'offer_type_id', value: $('form#create-offer-form #offer-type-select select option:selected').val()});
				data.push({name: 'country_name', value: fixedEncodeURI($('form#create-offer-form input#country-input').val())});
				data.push({name: 'city_name', value: fixedEncodeURI($('form#create-offer-form input#city-input').val())});
				data.push({name: 'c-count', value: $('form#create-offer-form input#c-count-input').val()});
				data.push({name: 'start-date', value: $('form#create-offer-form input#start-date-input').val()});
				data.push({name: 'finish-date', value: $('form#create-offer-form input#finish-date-input').val()});
				data.push({name: 'image', value: imageBase64});
				//console.log(data);
				
				$.ajax({
			        url: "/offer",
			        type: "POST",
			        data: data,
			        cache : false
			    }).done(function(resp) {
			    	
			    	if(resp.error != "" || resp == ""){
			    		
			    		alert("Ошибка создания предложения");
			    		//console.log(resp + " " + resp.error);
			    	} else if (resp.result[0] == "created"){
			    		
			    		alert("Предложение успешно создано");
			    	}
			    	
			    	preloaderOff();
				});
				
				//Reset the form
				$('form#create-offer-form input#title').val('');
				$('form#create-offer-form textarea#content').html('');
				populateOfferTypesSelect();
				$('form#create-offer-form input#country-input').val('');
				$('form#create-offer-form input#city-input').val('');
				$('form#create-offer-form input#c-count-input').val('');
				$('form#create-offer-form input#start-date-input').val('');
				$('form#create-offer-form input#finish-date-input').val('');
				$('form#create-offer-form input#image-input').val('');
				$('form#create-offer-form input.file-path').val('');
				
				isFormValid();
				$("form#create-offer-form button").attr('disabled', '');
				
				console.log($('form#create-offer-form textarea#content'));
				console.log($('form#create-offer-form textarea#content').html());
			});

			/*var preloaderHide = function() {

				$(".preloader-wrapper").css("display", "none");
			}*/

			setTimeout(preloaderOff, 500);
		};
	});
</script>